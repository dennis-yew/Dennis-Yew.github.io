<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>
    <link rel="stylesheet" href="/Projects/tomato.css">
</head>

<body class="light">

    <!-- Loading Screen -->

    <!-- 视频预加载动画 -->
    <div id="preload-container">

        <div id="preload-icon-wrapper">
            <img src="/assets//ui/element (2).png" alt="White Icon" class="icon" id="preload-icon-white">
            <img src="/assets//ui/element (1).png" alt="Gray Icon" class="icon" id="preload-icon-gray">
        </div>
    </div>
    <script>
        const preloadContainer = document.getElementById("preload-container");
        function updateProgressBar(progress) {
            const grayIcon = document.querySelector('#preload-icon-white');
            // 根据进度百分比调整灰度图标的显示
            grayIcon.style.clipPath = `inset(0 ${100 - progress}% 0 0)`;
        }

        // 测试：每隔 1 秒增加 10% 进度
        const stopPoints = [21, 67, 93, 93, 100];
        const stopDuration = 300; // 每个停顿点的持续时间
        let currentStopIndex = 0; // 当前的停顿点索引

        let progress = 0;
        const interval = setInterval(() => {
            if (progress == 100) {
                console.log("end");
                console.log("100%");

                clearInterval(interval);
                // 视频容器淡出
                preloadContainer.classList.add('hidden');
            } else {
                if (progress == 93) {
                    if (!document.querySelector('#oml2d-canvas')) {
                        console.log("pause");
                    } else {
                        console.log("update" + progress + "%");
                        // 将 progress 设置为下一个停顿点
                        progress = stopPoints[currentStopIndex];
                        // 移动到下一个停顿点
                        currentStopIndex++;
                        updateProgressBar(progress);
                    }
                } else {

                    console.log("update" + progress + "%");
                    // 将 progress 设置为下一个停顿点
                    progress = stopPoints[currentStopIndex];
                    // 移动到下一个停顿点
                    currentStopIndex++;
                    updateProgressBar(progress);
                }
            }
        }, stopDuration);

    </script>

        <div onclick="openDark(this)" class="toggle">
            <div></div>
        </div>

        <script type="text/javascript">
            function openDark(toggle) {
                let body = document.body;
                const Timerdisplay = document.querySelector('body > div.pomodoro-timer> div.timer-display');
                Timerdisplay.classList.toggle('darkmode');
                const DaysCounter = document.querySelector('#daysCounter');
                DaysCounter.classList.toggle('darkmode');
                if (toggle.state == null) {
                    toggle.state = false;
                }
                if (toggle.state) {
                    body.className = "light";
                } else {
                    body.className = "dark";
                }
                toggle.state = !toggle.state;
            }
        </script>



        <div class="pomodoro-timer">
            <h1>Pomodoro Timer</h1>
            <div class="timer-display">
                <span id="minutes">25</span>:<span id="seconds">00</span>
            </div>
            <div class="controls">
                <button id="start">Start</button>
                <button id="pause">Pause</button>
                <button id="reset">Reset</button>
            </div>
            <div class="session-controls">
                <button id="work">Work (25 min)</button>
                <button id="short-break">Short Break (5 min)</button>
                <button id="long-break">Long Break (15 min)</button>
            </div>
        </div>


        <script src="/assets/js/tomato.js"></script>
        <script src="/assets/js/live2d.js"></script>
        <!-- live2d -->
        <script type="module">
            let oml2d;
            let expressions; // 存储模型表情的数组
            // 选择 body 下所有 class 为 'pomodoro-timer' 的 div 元素
            const TimerContainer = document.querySelector('body > div.pomodoro-timer');
            // 创建组件实例并指定父元素

            // 载入 Live2D 模型
            function loadLive2DModel() {

                oml2d = OML2D.loadOml2d({
                    sayHello: true,
                    primaryColor: "#ff958b",
                    parentElement: TimerContainer,
                    mobileDisplay: true,
                    statusBar: {
                        // 在这里进行配置
                        disable: true,
                    },
                    menus: {
                        disable: false,
                        // 在这里配置
                    },
                    tips: {
                        messageLine: 4,
                        idleTips: { wordTheDay: !1, message: [], duration: 5e3, interval: 1e4, priority: 2 },
                        welcomeTip: {
                            message: {
                                daybreak: "早上好呀！新的大冒险就要开始啦！嘿嘿，可莉准备好了哦~",
                                morning: "早安早安！今天要去哪里探险呢？可莉已经迫不及待了！",
                                noon: "诶，中午了！要吃好吃的午饭吗？吃饱了才有力气炸鱼呢~",
                                afternoon: "下午好呀，这个时候有点困了呢…不过再玩一会儿也没关系吧？",
                                dusk: "天快黑啦~今天的探险很有趣呢！不过要小心，不要踩到可莉的蹦蹦炸弹哦！",
                                night: "晚上好！可莉今天玩得可开心啦~不过也要早点休息哦！",
                                lateNight: "已经这么晚了嘛？可莉有点困了…不过还是要说，晚安啦！",
                                weeHours: "咦？你还没睡吗？要注意身体哦，不然琴团长会像对可莉一样，‘禁闭’你的！"
                            },
                            duration: 6e3, priority: 2
                        },
                        style: {
                            "left": "110%",
                            "top": "20%",
                            "width": "250px",
                        },
                        mobileStyle: {
                            "left": "150px",
                            "top": "5%",
                            "width": "250px",
                        }
                    },
                    models: [
                        {
                            path: '/assets/model/klee/klee.model3.json',
                            position: [30, 0],
                            scale: 0.06,
                            stageStyle: {
                                "position": "relative",
                                "top": "-167%", /* 控制图片与闹钟的重叠程度，向上偏移 */
                                "transform": "translateX(-50%)", /* 确保图片水平居中 */
                                "width": "300px", /* 设定图片的宽度，可以根据需要调整 */
                                "z-index": "1" /* 图片位于闹钟的后面 */
                            },
                            mobilePosition: [10, 70],
                            mobileScale: 0.04,
                            mobileStageStyle: {
                                "position": "relative",
                                "top": "-39%",
                                "left": "-11%",
                                "height": "250px",
                                "width": "210px",
                                "z-index": "1"

                            }
                        },
                    ]
                });
                console.log(oml2d);
                console.log(oml2d.tips._tipsOptions["get tipsOptions"]);

                console.log(oml2d.modelIndex)
                console.log(oml2d.models.options.models[oml2d.models.currentModelIndex].path)
                const omlcanvas = document.querySelector("#oml2d-canvas");

                if (omlcanvas) { // 确保 canvas 元素存在
                    // 在这里调用 switchRandomExpression 函数，传入 modelConfig
                    omlcanvas.addEventListener("click", switchRandomExpression);
                    // 监听 touchstart 事件
                    omlcanvas.addEventListener('touchstart', function (event) {
                        switchRandomExpression();
                        // 阻止 touch 事件后触发 click 事件
                        event.preventDefault()
                    });
                } else {
                    console.error("omlcanvas 元素未找到");
                }

                // 音频播放控件
                let currentAudio = null;  // 用于存储当前播放的音频
                function playAudio(src) {
                    // 如果有正在播放的音频，先停止它
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio.currentTime = 0;  // 重置到开头
                    }

                    // 创建新的音频实例并播放
                    currentAudio = new Audio(src);
                    // 设置音量，默认值为1（最大音量），可以通过传参调整
                    currentAudio.volume = 0.3;
                    currentAudio.play();
                }


                // 监听 window 上的自定义事件，并获取数据
                // 
                window.addEventListener('TimerStart', (event) => {
                    console.log('Received event data:', event.detail);  // 读取 file1.js 传递的数据
                    console.log('Received event data:', event.detail);  // 读取 file1.js 传递的数据
                    switchExpression(event.detail);
                    oml2d.clearTips();
                    const sentence = "好耶！是大冒险！";
                    oml2d.tipsMessage(sentence, 6000, 2);
                    playAudio('/assets/model/klee/sounds/大冒险.mp3');


                });
                window.addEventListener('TimerPause', (event) => {
                    console.log('Received event data:', event.detail);  // 读取 file1.js 传递的数据
                    switchExpression(event.detail);
                    oml2d.clearTips();
                    const sentence = "玩累了。。。有点晕。。。";
                    oml2d.tipsMessage(sentence, 4000, 2);
                    playAudio('/assets/model/klee/sounds/休息.mp3');

                });
                window.addEventListener('TimerEnd', (event) => {
                    console.log('Received event data:', event.detail.eventData);  // 读取 file1.js 传递的数据
                    switchExpression(event.detail.eventData);
                    console.log(event.detail.keys);
                    oml2d.clearTips();
                    const sentence = "可莉又找到新的宝物啦! " + "关键词：[" + event.detail.keys + "]";
                    oml2d.tipsMessage(sentence, 10000, 2);
                    playAudio('/assets/model/klee/sounds/宝物.mp3');

                });
                window.addEventListener('AfterEndTimerEnd', (event) => {
                    console.log('Received event data:', event.detail);  // 读取 file1.js 传递的数据
                    switchExpression(event.detail);
                    oml2d.clearTips();
                    const sentence = "火力全开!";
                    oml2d.tipsMessage(sentence, 4000, 2);
                    playAudio('/assets/model/klee/sounds/火力全开.mp3');

                });
                window.addEventListener('ChangeTimer', (event) => {
                    console.log('Received event data:', event.detail);  // 读取 file1.js 传递的数据
                    switchExpression(event.detail);
                    oml2d.clearTips();
                    const sentence = "可莉来帮忙~";
                    oml2d.tipsMessage(sentence, 4000, 2);
                    playAudio('/assets/model/klee/sounds/来帮忙.mp3');

                });

            }

            // 根据索引切换表情
            function switchExpression(ExpressionIndex) {
                const currentmodel = oml2d.models.model.internalModel;
                if (!currentmodel.motionManager.expressionManager.setExpression(ExpressionIndex)) {
                    console.log("expression doesn't Exist");
                }
            }
            // 切换到随机表情
            function switchRandomExpression() {
                const currentmodel = oml2d.models.model.internalModel;
                console.log(currentmodel.motionManager.motionGroups);
                console.log(oml2d.models.currentModelOptions.path);
                oml2d.models.playRandomMotion('TapBody');
                if (!currentmodel.motionManager.expressionManager.setRandomExpression()) {
                    console.log("expression doesn't Exist");
                }
            }
            loadLive2DModel();
            // setTimeout(loadLive2DModel,6000); 延时加载模型
        </script>




        <!-- 页脚记录天数 -->
        <div id="daysCounter">&copy; 2024 Dennis. All rights reserved | <span id="days"></span> days in love</div>
        <!-- // 计算开放天数的函数 -->
        <script>

            function calculateDaysSinceLaunch() {
                // 网站开放日期 (2023-12-27)
                const launchDate = new Date('2023-12-27');
                // 获取当前日期
                const currentDate = new Date();
                // 计算差值 (毫秒)
                const timeDifference = currentDate - launchDate;
                // 将毫秒转换为天数
                const daysSinceLaunch = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
                return daysSinceLaunch;
            }

            // 将天数显示在页面上
            document.getElementById('days').innerText = calculateDaysSinceLaunch();
        </script>

    </body>

</html>