<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>
    <link rel="stylesheet" href="/Projects/tomato.css">
</head>

<body>
    <div class="pomodoro-timer">
        <h1>Pomodoro Timer</h1>
        <div class="timer-display">
            <span id="minutes">25</span>:<span id="seconds">00</span>
        </div>
        <div class="controls">
            <button id="start">Start</button>
            <button id="pause">Pause</button>
            <button id="reset">Reset</button>
        </div>
        <div class="session-controls">
            <button id="work">Work (25 min)</button>
            <button id="short-break">Short Break (5 min)</button>
            <button id="long-break">Long Break (15 min)</button>
        </div>
    </div>
    <script src="/assets/js/tomato.js"></script>

    <script src="/assets/js/live2d.js"></script>
    <script>
        let oml2d;
        let expressions; // 存储模型表情的数组
        // 选择 body 下所有 class 为 'pomodoro-timer' 的 div 元素
        const TimerContainer = document.querySelector('body > div.pomodoro-timer');
        // 创建组件实例并指定父元素

        function loadLive2DModel() {
            // 载入 Live2D 模型

            oml2d = OML2D.loadOml2d({
                sayHello: true,
                primaryColor: "#ff958b",
                parentElement: TimerContainer,
                mobileDisplay: true,
                statusBar: {
                    // 在这里进行配置
                    disable: true,
                },
                menus: {
                    disable: false,
                    // 在这里配置
                },
                tips: {
                    welcomeTip: {
                        message: {
                            daybreak: "早上好！一日之计在于晨，美好的一天就要开始了。",
                            morning: "早啊，带可莉去玩吧，我们一起来冒险",
                            noon: "中午了，工作了一个上午，现在是午餐时间！",
                            afternoon: "午后很容易犯困呢，来杯咖啡吧~",
                            dusk: "傍晚了！工作一天幸苦啦~",
                            night: "晚上好，今天过得怎么样呢？",
                            lateNight: "已经这么晚了呀，早点休息吧，晚安~",
                            weeHours: "这么晚还不睡吗？当心熬夜秃头哦！"
                        }
                    },
                    style: {
                        "left": "110%",
                        "top": "20%",
                        "width": "250px",
                    },
                    mobileStyle: {
                        "left": "150px",
                        "top": "5%",
                        "width": "250px",
                    }
                },
                models: [
                    {
                        path: '/assets/model/klee/klee.model3.json',
                        position: [30, 0],
                        scale: 0.06,
                        stageStyle: {
                            "position": "relative",
                            "top": "-164%", /* 控制图片与闹钟的重叠程度，向上偏移 */
                            "transform": "translateX(-50%)", /* 确保图片水平居中 */
                            "width": "300px", /* 设定图片的宽度，可以根据需要调整 */
                            "z-index": "1" /* 图片位于闹钟的后面 */
                        },
                        mobilePosition: [10, 70],
                        mobileScale: 0.04,
                        mobileStageStyle: {
                            "position": "relative",
                            "top": "-72%",
                            "left": "-11%",
                            "height": "250px",
                            "width": "210px",
                            "z-index": "1"

                        }
                    },
                ]
            });
            console.log(oml2d);
            oml2d.clearTips();
            console.log(oml2d.models.currentModelIndex)
            console.log(oml2d.modelIndex)
            console.log(oml2d.models.options.models[oml2d.models.currentModelIndex].path)

            const omlcanvas = document.querySelector("#oml2d-canvas");

            if (omlcanvas) { // 确保 canvas 元素存在
                // 在这里调用 switchRandomExpression 函数，传入 modelConfig
                omlcanvas.addEventListener("click", switchRandomExpression);
                // 监听 touchstart 事件
                omlcanvas.addEventListener('touchstart', function (event) {
                    switchRandomExpression();
                    // 阻止 touch 事件后触发 click 事件
                    event.preventDefault()
                });
            } else {
                console.error("omlcanvas 元素未找到");
            }

            // 音频播放控件
            let currentAudio = null;  // 用于存储当前播放的音频

            function playAudio(src) {
                // 如果有正在播放的音频，先停止它
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;  // 重置到开头
                }

                // 创建新的音频实例并播放
                currentAudio = new Audio(src);
                currentAudio.play();
            }

            
            // 监听 window 上的自定义事件，并获取数据
            // 
            window.addEventListener('TimerStart', (event) => {
                console.log('Received event data:', event.detail);  // 读取 file1.js 传递的数据
                console.log('Received event data:', event.detail);  // 读取 file1.js 传递的数据
                switchExpression(event.detail);
                oml2d.clearTips();
                const sentence = "好耶！是大冒险！";
                oml2d.tipsMessage(sentence, 6000, 2);
                playAudio('/assets/model/klee/sounds/大冒险.mp3');
                

            });
            window.addEventListener('TimerPause', (event) => {
                console.log('Received event data:', event.detail);  // 读取 file1.js 传递的数据
                switchExpression(event.detail);
                oml2d.clearTips();
                const sentence = "玩累了。。。有点晕。。。";
                oml2d.tipsMessage(sentence, 4000, 2);
                playAudio('/assets/model/klee/sounds/休息.mp3');
                
            });
            window.addEventListener('TimerEnd', (event) => {
                console.log('Received event data:', event.detail.eventData);  // 读取 file1.js 传递的数据
                switchExpression(event.detail.eventData);
                console.log(event.detail.keys);
                oml2d.clearTips();
                const sentence = "可莉又找到新的宝物啦! " +"关键词：["+ event.detail.keys + "]";
                oml2d.tipsMessage(sentence, 10000, 2);
                playAudio('/assets/model/klee/sounds/宝物.mp3');
                
            });
            window.addEventListener('AfterEndTimerEnd', (event) => {
                console.log('Received event data:', event.detail);  // 读取 file1.js 传递的数据
                switchExpression(event.detail);
                oml2d.clearTips();
                const sentence = "火力全开!";
                oml2d.tipsMessage(sentence, 4000, 2);
                playAudio('/assets/model/klee/sounds/火力全开.mp3');
                
            });
            window.addEventListener('ChangeTimer', (event) => {
                console.log('Received event data:', event.detail);  // 读取 file1.js 传递的数据
                switchExpression(event.detail);
                oml2d.clearTips();
                const sentence = "可莉来帮忙~";
                oml2d.tipsMessage(sentence, 4000, 2);
                playAudio('/assets/model/klee/sounds/来帮忙.mp3');
                
            });

        }
        function switchExpression(ExpressionIndex) {
            const currentmodel = oml2d.models.model.internalModel;
            if (!currentmodel.motionManager.expressionManager.setExpression(ExpressionIndex)) {
                console.log("expression doesn't Exist");
            }
        }
        // 切换到随机表情
        function switchRandomExpression() {
            const currentmodel = oml2d.models.model.internalModel;
            console.log(currentmodel.motionManager.motionGroups);
            console.log(oml2d.models.currentModelOptions.path);
            oml2d.models.playRandomMotion('TapBody');
            if (!currentmodel.motionManager.expressionManager.setRandomExpression()) {
                console.log("expression doesn't Exist");
            }
            // fetch(oml2d.models.currentModelOptions.path) // 模型表情 JSON 文件的路径
            //     .then(response => response.json())
            //     .then(data => {
            //         console.log(data);
            //         expressions = data.FileReferences.Expressions; // 保存表情列表
            //         console.log('Expressions loaded:', expressions);
            //     })
            //     .catch(error => console.error('Error loading expressions:', error));

            // console.log('oml2d.models.model.internalModel', model);
            // if ((expressions !== undefined) && model) {
            //     const randomIndex = Math.floor(Math.random() * expressions.length);
            //     const randomExpression = expressions[randomIndex];

            //     // 设置模型的表情
            //     console.log('randomIndex:', randomIndex);
            //     console.log('randomExpression:', randomExpression);
            //     model.motionManager.expressionManager.setExpression(randomIndex)
            // } else {
            //     console.log('expressions is empty');
            // }
        }
        loadLive2DModel();

    </script>
</body>

</html>